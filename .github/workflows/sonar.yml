name: Sonar Continuos Integration
env:
  DOTNET_VERSION: '9.0.x'
  SONAR_ORG: 'ORGANIZATION'
  SONAR_PROJECT: 'PROJECT_KEY'
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  sonarqube:
    name: Sonarqube Analysis + Pack + Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Configurar .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Instalar Sonar Scanner
        run: dotnet tool install -g dotnet-sonarscanner
      - name: Restaurar dependencias
        run: dotnet restore ./Bank/Bank.sln
      - name: Ejecutar pruebas con cobertura
        run: dotnet test ./Bank/Bank.sln --collect:"XPlat Code Coverage;Format=opencover"
      - name: SonarCloud begin
        run: |
          dotnet-sonarscanner begin \
            /k:"${{ env.SONAR_PROJECT }}" \
            /o:"${{ env.SONAR_ORG }}" \
            /d:sonar.login:"${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml" \
            /d:sonar.qualitygate.wait=true
      - name: Compilar soluci√≥n
        run: dotnet build ./Bank/Bank.sln --configuration Release
      - name: SonarCloud end
        run: dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
      - name: Empaquetar NuGet
        run: dotnet pack ./Bank/Bank.Domain/Bank.Domain.csproj -c Release -o ./artifacts
      - name: Publicar paquete en GitHub Packages
        env:
          NUGET_SOURCE: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
          NUGET_API_KEY: ${{ secrets.GITHUB_TOKEN }}
        run: dotnet nuget push ./artifacts/*.nupkg --source $NUGET_SOURCE --api-key $NUGET_API_KEY --skip-duplicate
      - name: Crear release v1.0.0 con notas de commits
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.0
          name: v1.0.0
          generate_release_notes: true
          files: artifacts/*.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
